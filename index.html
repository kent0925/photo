<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾åœ˜æ™‚å…‰ç›¸ç°¿</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { 
            background-color: #e5d3b3; 
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            font-family: "Courier New", Courier, "Microsoft JhengHei", monospace;
            color: #5d4037; margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        /* éš±è—é è¨­ input */
        .hidden-input { display: none; }

        /* æŒ‰éµå¼å¡ç‰‡ */
        .upload-card-btn {
            background: #fffef0; width: 90%; max-width: 350px;
            padding: 20px; margin-bottom: 15px; border: 2px solid #5d4037;
            text-align: center; cursor: pointer; box-shadow: 6px 6px 0px #5d4037;
            transition: 0.2s; display: flex; flex-direction: column; align-items: center;
        }
        .upload-card-btn:active { transform: translate(3px, 3px); box-shadow: 3px 3px 0px #5d4037; }
        .upload-card-btn h4 { margin: 0; font-size: 18px; }
        .upload-card-btn span { font-size: 11px; margin-top: 5px; color: #8d6e63; }

        #globalStatus { font-size: 12px; margin-bottom: 15px; color: #b71c1c; font-weight: bold; text-align: center; min-height: 18px; }

        /* ç›¸ç°¿ç¶²æ ¼ç³»çµ± */
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; max-width: 400px; }
        .card { background: #fffef0; padding: 10px; border: 1px solid #5d4037; cursor: pointer; text-align: center; box-shadow: 4px 4px 0px #5d4037; }
        .card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
        .photo-item { background: white; padding: 10px 10px 25px 10px; border: 1px solid #ddd; position: relative; box-shadow: 3px 3px 8px rgba(0,0,0,0.1); cursor: pointer; }
        .photo-item img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
        .video-label { position: absolute; top: 10px; left: 10px; right: 10px; aspect-ratio: 1/1; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; z-index: 1; }

        /* é è¦½èˆ‡æµ®å‹•é¸å–® */
        #viewerOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        #viewerContent { width: 95%; max-width: 500px; height: 80vh; position: relative; display: flex; align-items: center; justify-content: center; }
        #closeBtn { position: absolute; top: -50px; right: 10px; color: white; font-size: 35px; cursor: pointer; font-weight: bold; }
        .floating-menu { position: fixed; bottom: 25px; right: 20px; display: none; flex-direction: column; gap: 12px; z-index: 999; }
        .fab { width: 55px; height: 55px; border-radius: 50%; background: #5d4037; color: #e5d3b3; border: 2px solid #e5d3b3; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <h2 id="userName">ğŸï¸ è¼‰å…¥å›æ†¶ä¸­...</h2>
    <div id="globalStatus"></div>

    <div class="upload-card-btn" onclick="document.getElementById('imageInput').click()">
        <h4>ğŸ“¸ æŠ•ç¨¿ç…§ç‰‡</h4>
        <span>æ”¯æ´å¤šé¸ï¼Œé‡è¤‡å°‡è‡ªå‹•è·³éä¸¦ç´€éŒ„å§“å</span>
        <input type="file" id="imageInput" class="hidden-input" accept="image/*" multiple onchange="processImages(this)">
    </div>

    <div class="upload-card-btn" onclick="document.getElementById('videoInput').click()" style="border-color: #8d6e63;">
        <h4 style="color: #8d6e63;">ğŸ¥ æŠ•ç¨¿å½±ç‰‡</h4>
        <span>æ”¯æ´å¤šé¸ï¼Œä¸Šé™ 30MBï¼Œè‡ªå‹•ç½®é ‚</span>
        <input type="file" id="videoInput" class="hidden-input" accept="video/*" multiple onchange="processVideos(this)">
    </div>

    <div id="loading">æ­£åœ¨é–‹å•Ÿç›¸ç°¿...</div>
    <div id="albumGrid" class="grid-container"></div>
    <div id="photoGrid" class="grid-container" style="display:none;"></div>

    <div id="viewerOverlay"><div id="viewerContent"><span id="closeBtn" onclick="closeViewer()">âœ•</span></div></div>

    <div id="floatingMenu" class="floating-menu">
        <div class="fab" onclick="window.scrollTo({top:0, behavior:'smooth'})">TOP</div>
        <div class="fab" onclick="showAlbumList()">è¿”å›<br>åˆ—è¡¨</div>
    </div>

    <script>
        const gasUrl = 'https://script.google.com/macros/s/AKfycbyBsFLlYt415vWiBipXhvycp_OMoQAJZdtfBi85IvQ29sfyCQphy6P0RrhMndpoLT33/exec'; 
        const liffId = '2008678090-ZMqCkYFi'; 
        let allData = { categories: [], allFiles: [] };

        // æå–ç´”å§“å
        function getPureUserName() {
            return document.getElementById('userName').innerText.replace('ğŸ“½ï¸ ', '').replace(' çš„ç›¸ç°¿', '').trim();
        }

        // æª¢æŸ¥é‡è¤‡
        function isDuplicate(fileName) {
            return allData.allFiles.some(file => file.name === fileName);
        }

        // åœ–ç‰‡å£“ç¸®
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > h && w > 1200) { h *= 1200 / w; w = 1200; }
                        else if (h > 1200) { w *= 1200 / h; h = 1200; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.8)); 
                    };
                };
            });
        }

        // è™•ç†ç…§ç‰‡ (ä¿ç•™åŸé‚è¼¯ + åŠ å…¥ userName)
        async function processImages(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;
            const status = document.getElementById('globalStatus');
            disableButtons(true);

            for (let file of files) {
                const checkName = file.name.split('.')[0] + ".jpg";
                if (isDuplicate(checkName)) {
                    alert(`ã€è·³éã€‘ç…§ç‰‡ã€Œ${file.name}ã€å·²å­˜åœ¨æ–¼ç›¸ç°¿ä¸­ã€‚`);
                    continue;
                }
                status.innerText = `â³ æ­£åœ¨ä¸Šå‚³ç…§ç‰‡: ${file.name}`;
                try {
                    const data = await compressImage(file);
                    await fetch(gasUrl, { 
                        method: "POST", 
                        body: JSON.stringify({ 
                            fileName: checkName, 
                            fileData: data,
                            userName: getPureUserName() // å‚³é€ä¸Šå‚³è€…å§“å
                        })
                    });
                } catch (e) { console.error(e); }
            }
            alert("ç…§ç‰‡æŠ•ç¨¿è™•ç†çµæŸ");
            finishUpload(input);
        }

        // è™•ç†å½±ç‰‡ (å¤šé¸ + 30MB + é‡è¤‡æª¢æŸ¥ + userName)
        async function processVideos(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;
            const status = document.getElementById('globalStatus');
            disableButtons(true);

            for (let file of files) {
                if (file.size > 30 * 1024 * 1024) {
                    alert(`âš ï¸ å½±ç‰‡ã€Œ${file.name}ã€å¤ªå¤§ (${Math.round(file.size/1024/1024)}MB)\nç”±æ–¼è¶…é 30MBï¼Œè«‹æ”¹å‚³è‡³ LINE ç¾¤çµ„ï¼`);
                    continue;
                }
                if (isDuplicate(file.name)) {
                    alert(`ã€è·³éã€‘å½±ç‰‡ã€Œ${file.name}ã€å·²å­˜åœ¨æ–¼ç›¸ç°¿ä¸­ã€‚`);
                    continue;
                }
                status.innerText = `â³ æ­£åœ¨å‚³é€å½±ç‰‡: ${file.name}`;
                try {
                    const base64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                    await fetch(gasUrl, { 
                        method: "POST", 
                        body: JSON.stringify({ 
                            fileName: file.name, 
                            fileData: base64,
                            userName: getPureUserName() // å‚³é€ä¸Šå‚³è€…å§“å
                        })
                    });
                } catch (e) { console.error(e); }
            }
            alert("å½±ç‰‡æŠ•ç¨¿è™•ç†çµæŸ");
            finishUpload(input);
        }

        function disableButtons(bool) {
            const btns = document.querySelectorAll('.upload-card-btn');
            btns.forEach(b => { b.style.opacity = bool ? "0.5" : "1"; b.style.pointerEvents = bool ? "none" : "auto"; });
        }

        function finishUpload(input) {
            document.getElementById('globalStatus').innerText = "";
            disableButtons(false); input.value = ""; fetchData();
        }

        // åŸæœ‰é‚è¼¯ï¼šè§£æ Google Drive ID
        function getFileId(url) {
            let id = "";
            if (url.includes('id=')) id = url.split('id=')[1].split('&')[0];
            else { const match = url.match(/\/d\/(.+?)\//); if (match) id = match[1]; }
            return id;
        }

        // åŸæœ‰é‚è¼¯ï¼šLIFF åˆå§‹åŒ–
        async function initLIFF() {
            try {
                await liff.init({ liffId });
                if (!liff.isLoggedIn()) liff.login();
                else {
                    const profile = await liff.getProfile();
                    document.getElementById('userName').innerText = `ğŸ“½ï¸ ${profile.displayName} çš„ç›¸ç°¿`;
                    fetchData();
                }
            } catch (err) { fetchData(); }
        }

        // åŸæœ‰é‚è¼¯ï¼šæŠ“å–è³‡æ–™ (åŠ å…¥ç½®é ‚æ’åº)
        async function fetchData() {
            try {
                const response = await fetch(gasUrl);
                allData = await response.json();
                
                // å¼·åˆ¶æ’åºï¼šæœ€æ–°çš„æ—¥æœŸ (date) æ’åœ¨æœ€ä¸Šé¢
                if (allData.allFiles) {
                    allData.allFiles.sort((a, b) => new Date(b.date) - new Date(a.date));
                }

                document.getElementById('loading').style.display = 'none';
                showAlbumList();
            } catch (err) { document.getElementById('loading').innerText = "è¼‰å…¥å¤±æ•—"; }
        }

        // åŸæœ‰é‚è¼¯ï¼šç›¸ç°¿åˆ—è¡¨
        function showAlbumList() {
            document.getElementById('floatingMenu').style.display = 'none';
            document.getElementById('photoGrid').style.display = 'none';
            const albumGrid = document.getElementById('albumGrid');
            albumGrid.style.display = 'grid'; albumGrid.innerHTML = "";
            allData.categories.forEach(cat => {
                const photos = allData.allFiles.filter(p => String(p.category) === String(cat.name));
                const fid = photos[0] ? getFileId(photos[0].url) : "";
                const coverUrl = fid ? `https://drive.google.com/thumbnail?id=${fid}&sz=w400` : "";
                const div = document.createElement('div');
                div.className = 'card'; div.onclick = () => showPhotos(cat.name);
                div.innerHTML = `<img src="${coverUrl}"><div style="font-size:12px;margin-top:5px;">${cat.name} (${photos.length})</div>`;
                albumGrid.appendChild(div);
            });
        }

        // åŸæœ‰é‚è¼¯ï¼šç…§ç‰‡ç¶²æ ¼
        function showPhotos(catName) {
            document.getElementById('albumGrid').style.display = 'none';
            document.getElementById('floatingMenu').style.display = 'flex';
            const photoGrid = document.getElementById('photoGrid');
            photoGrid.style.display = 'grid'; photoGrid.innerHTML = "";
            allData.allFiles.filter(p => String(p.category) === String(catName)).forEach(item => {
                const fid = getFileId(item.url);
                const thumb = `https://drive.google.com/thumbnail?id=${fid}&sz=w600`;
                const isVideo = item.type.includes('video');
                const div = document.createElement('div');
                div.className = 'photo-item'; div.onclick = () => openViewer(fid, isVideo);
                let icon = isVideo ? '<div class="video-label">â–¶</div>' : '';
                div.innerHTML = `${icon}<img src="${thumb}"><p style="font-size:10px;text-align:center;margin-top:5px;">${item.name}</p>`;
                photoGrid.appendChild(div);
            });
            window.scrollTo(0,0);
        }

        // åŸæœ‰é‚è¼¯ï¼šé è¦½åŠŸèƒ½
        function openViewer(id, isVideo) {
            const content = document.getElementById('viewerContent');
            const overlay = document.getElementById('viewerOverlay');
            content.innerHTML = '<span id="closeBtn" onclick="closeViewer()">âœ•</span>';
            if (isVideo) {
                content.innerHTML += `<div style="text-align:center;"><img src="https://drive.google.com/thumbnail?id=${id}&sz=w600" style="width:80%; border-radius:10px;"><br><button onclick="window.open('https://drive.google.com/file/d/${id}/view')" style="margin-top:20px; background:#5d4037; color:#e5d3b3; border:none; padding:15px 30px; border-radius:30px; font-weight:bold; cursor:pointer;">æ’­æ”¾å½±ç‰‡ â–¶</button></div>`;
            } else {
                content.innerHTML += `<img src="https://drive.google.com/thumbnail?id=${id}&sz=w1200" style="max-width:100%; max-height:100%; object-fit:contain;">`;
            }
            overlay.style.display = 'flex'; document.body.style.overflow = 'hidden';
        }

        function closeViewer() { document.getElementById('viewerOverlay').style.display = 'none'; document.body.style.overflow = 'auto'; }

        initLIFF();
    </script>
</body>
</html>
