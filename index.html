<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾åœ˜æ™‚å…‰ç›¸ç°¿</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { 
            background-color: #e5d3b3; 
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            font-family: "Courier New", Courier, "Microsoft JhengHei", monospace;
            color: #5d4037; margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        /* æ¨™é¡Œèˆ‡å°è¦½ */
        .header-box { text-align: center; width: 100%; max-width: 500px; margin-bottom: 20px; }
        #backBtn { 
            display: none; background: #5d4037; color: #e5d3b3; border: none; 
            padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-bottom: 15px;
            font-weight: bold; font-size: 16px; box-shadow: 3px 3px 0px #8d6e63;
        }

        /* ç›¸ç°¿åˆ—è¡¨ (é¦–é ) */
        .album-grid { 
            display: grid; grid-template-columns: repeat(2, 1fr); 
            gap: 20px; width: 100%; max-width: 600px; 
        }

        .album-card {
            background: #fffef0; padding: 10px; border: 1px solid #5d4037;
            box-shadow: 5px 5px 0px #5d4037; cursor: pointer; text-align: center;
        }

        .album-cover { width: 100%; height: 120px; object-fit: cover; background: #ddd; border: 1px solid #ccc; }
        .album-title { margin-top: 10px; font-weight: bold; font-size: 14px; }

        /* ç…§ç‰‡èˆ‡å½±ç‰‡ç¶²æ ¼ */
        .photo-grid { 
            display: none; grid-template-columns: repeat(2, 1fr); 
            gap: 15px; width: 100%; 
        }

        .photo-item {
            background: white; padding: 8px 8px 10px 8px;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.2); border: 1px solid #eee;
            display: flex; flex-direction: column;
        }

        .photo-item img, .photo-item video { 
            width: 100%; height: 150px; object-fit: cover; background: #000; 
        }

        #uploadSection {
            background: rgba(255, 254, 240, 0.9); padding: 15px; 
            margin-bottom: 25px; border: 2px solid #5d4037; width: 90%; max-width: 350px; text-align: center;
        }
        #loading { font-style: italic; color: #8d6e63; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="header-box">
        <h2 id="userName">ğŸï¸ è¼‰å…¥å›æ†¶ä¸­...</h2>
        <button id="backBtn" onclick="showAlbumList()">â† è¿”å›ç›¸ç°¿åˆ—è¡¨</button>
    </div>

    <div id="uploadSection">
        <h4 style="margin:0;">æŠ•ç¨¿æ–°å›æ†¶</h4>
        <input type="file" id="fileInput" accept="image/*,video/*">
        <button onclick="uploadFile()" id="uploadBtn" style="width:100%; background:#5d4037; color:#e5d3b3; border:none; padding:10px; cursor:pointer; font-weight:bold; margin-top:10px;">é€å‡º</button>
    </div>

    <div id="loading">æ­£åœ¨ç¿»é–±ç›¸ç°¿...</div>

    <div id="albumGrid" class="album-grid"></div>
    <div id="photoGrid" class="photo-grid"></div>

    <script>
        const gasUrl = 'https://script.google.com/macros/s/AKfycbyBsFLlYt415vWiBipXhvycp_OMoQAJZdtfBi85IvQ29sfyCQphy6P0RrhMndpoLT33/exec'; 
        const liffId = '2008678090-ZMqCkYFi'; 

        let allData = { categories: [], allFiles: [] };

        // è¼”åŠ©å·¥å…·ï¼šå¾ Google Drive ç¶²å€æŠ“å– ID
        function getFileId(url) {
            let id = "";
            if (url.includes('id=')) {
                id = url.split('id=')[1].split('&')[0];
            } else {
                const match = url.match(/\/d\/(.+?)\//);
                if (match) id = match[1];
            }
            return id;
        }

        async function initLIFF() {
            try {
                await liff.init({ liffId: liffId });
                if (!liff.isLoggedIn()) liff.login();
                else {
                    const profile = await liff.getProfile();
                    document.getElementById('userName').innerText = `ğŸ“½ï¸ ${profile.displayName} çš„ç›¸ç°¿`;
                    fetchData();
                }
            } catch (err) { fetchData(); }
        }

        async function fetchData() {
            try {
                const response = await fetch(gasUrl);
                allData = await response.json();
                document.getElementById('loading').style.display = 'none';
                showAlbumList();
            } catch (err) {
                document.getElementById('loading').innerText = "è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
            }
        }

        function showAlbumList() {
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('photoGrid').style.display = 'none';
            const albumGrid = document.getElementById('albumGrid');
            albumGrid.style.display = 'grid';
            albumGrid.innerHTML = "";

            allData.categories.forEach(cat => {
                const photosInCat = allData.allFiles.filter(p => String(p.category) === String(cat.name));
                const first = photosInCat[0];
                const fid = first ? getFileId(first.url) : "";
                const coverUrl = fid ? `https://drive.google.com/thumbnail?id=${fid}&sz=w400` : "";

                const card = document.createElement('div');
                card.className = 'album-card';
                card.onclick = () => showPhotos(cat.name);
                card.innerHTML = `
                    <img class="album-cover" src="${coverUrl}">
                    <div class="album-title">${cat.name} (${photosInCat.length}å¼µ)</div>
                `;
                albumGrid.appendChild(card);
            });
        }

        function showPhotos(categoryName) {
            document.getElementById('albumGrid').style.display = 'none';
            document.getElementById('backBtn').style.display = 'inline-block';
            const photoGrid = document.getElementById('photoGrid');
            photoGrid.style.display = 'grid';
            photoGrid.innerHTML = "";

            const filtered = allData.allFiles.filter(p => String(p.category) === String(categoryName));

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                const fid = getFileId(item.url);
                
                let media = "";
                if (item.type.includes('video')) {
                    const videoUrl = `https://drive.google.com/uc?export=download&id=${fid}`;
                    media = `<video controls playsinline><source src="${videoUrl}"></video>`;
                } else {
                    const thumbUrl = `https://drive.google.com/thumbnail?id=${fid}&sz=w600`;
                    media = `<img src="${thumbUrl}" loading="lazy" onclick="window.open('https://drive.google.com/open?id=${fid}')">`;
                }
                
                div.innerHTML = `${media}<p style="font-size:11px; text-align:center; margin-top:5px;">${item.name}</p>`;
                photoGrid.appendChild(div);
            });
            window.scrollTo(0, 0);
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) return alert("è«‹é¸å–æª”æ¡ˆ");
            const btn = document.getElementById('uploadBtn');
            btn.innerText = "å‚³é€ä¸­..."; btn.disabled = true;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const payload = { fileName: fileInput.files[0].name, fileData: e.target.result };
                    await fetch(gasUrl, { method: "POST", body: JSON.stringify(payload) });
                    alert("ä¸Šå‚³æˆåŠŸï¼å¯©æ ¸å¾Œæœƒå‡ºç¾ã€‚");
                    fileInput.value = "";
                } catch (err) { alert("å¤±æ•—"); }
                finally { btn.innerText = "é€å‡º"; btn.disabled = false; }
            };
            reader.readAsDataURL(fileInput.files[0]);
        }

        initLIFF();
    </script>
</body>
</html>
