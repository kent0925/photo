<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾åœ˜å¾©å¤æ™‚å…‰æ©Ÿ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* å¾©å¤è¦–è¦ºé¢¨æ ¼ */
        body { 
            background-color: #e5d3b3; 
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            font-family: "Courier New", Courier, "Microsoft JhengHei", monospace;
            color: #5d4037;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        h2 { text-shadow: 1px 1px 2px rgba(0,0,0,0.2); border-bottom: 2px dashed #5d4037; padding-bottom: 10px; }

        /* ä¸Šå‚³å€å¡Š */
        #uploadSection {
            background: rgba(255, 254, 240, 0.9);
            padding: 20px; margin-bottom: 30px;
            border: 2px solid #5d4037;
            box-shadow: 8px 8px 0px #5d4037;
            width: 90%; max-width: 350px; text-align: center;
        }

        input[type="file"] { width: 100%; margin: 15px 0; }

        button {
            background-color: #5d4037; color: #e5d3b3;
            width: 100%; padding: 12px; border: none;
            font-weight: bold; cursor: pointer; font-size: 16px;
        }

        button:disabled { background-color: #999; }

        /* ç›¸ç°¿å±•ç¤ºå€ (æ‹ç«‹å¾—é¢¨æ ¼) */
        .gallery { display: flex; flex-wrap: wrap; justify-content: center; gap: 25px; width: 100%; }

        .item { 
            background: #fffef0; padding: 12px 12px 35px 12px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.3);
            border: 1px solid #ddd; width: 160px;
            transition: transform 0.3s;
        }

        .item:nth-child(odd) { transform: rotate(-2deg); }
        .item:nth-child(even) { transform: rotate(2deg); }
        .item:hover { transform: rotate(0deg) scale(1.1); z-index: 5; }

        .item img, .item video { 
            width: 100%; height: 150px; object-fit: cover;
            filter: sepia(10%) contrast(95%); border: 1px solid #ccc;
            background: #eee;
        }

        .category-tag {
            font-size: 10px; color: #8d6e63; margin: 8px 0 2px 0;
            font-weight: bold; text-align: center;
        }

        .file-name {
            margin: 0; font-size: 12px;
            color: #795548; text-align: center;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        #loading { font-style: italic; color: #8d6e63; margin-top: 20px; }
    </style>
</head>
<body>

    <h2 id="userName">ğŸï¸ è¼‰å…¥å›æ†¶ä¸­...</h2>

    <div id="uploadSection">
        <h4 style="margin:0;">æŠ•ç¨¿æ–°ç…§ç‰‡</h4>
        <p style="font-size: 12px; color: #8d6e63;">ç…§ç‰‡å°‡å…ˆé€è‡³å¾Œå°ç®¡ç†å“¡å¯©æ ¸</p>
        <input type="file" id="fileInput" accept="image/*,video/*">
        <button onclick="uploadFile()" id="uploadBtn">é€å‡ºå›æ†¶</button>
    </div>

    <div id="loading">æ­£åœ¨ç¿»é–±ç›¸ç°¿...</div>
    <div class="gallery" id="gallery"></div>

    <script>
        const gasUrl = 'https://script.google.com/macros/s/AKfycbyBsFLlYt415vWiBipXhvycp_OMoQAJZdtfBi85IvQ29sfyCQphy6P0RrhMndpoLT33/exec'; 
        const liffId = '2008678090-ZMqCkYFi'; 

        let currentUser = "ç¤¾åœ˜å¤¥ä¼´";

        // 1. åˆå§‹åŒ– LIFF
        async function initLIFF() {
            try {
                await liff.init({ liffId: liffId });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    currentUser = profile.displayName;
                    document.getElementById('userName').innerText = `ğŸ“½ï¸ ${currentUser} çš„æ™‚å…‰æ©Ÿ`;
                    fetchData();
                }
            } catch (err) {
                console.log("LIFF è¼‰å…¥å¤±æ•—ï¼Œå¯èƒ½åœ¨ä¸€èˆ¬ç€è¦½å™¨ä¸­é‹è¡Œ");
                fetchData();
            }
        }

        // 2. æŠ“å–ç…§ç‰‡ (æ”¯æ´ç‰©ä»¶æ ¼å¼)
        async function fetchData() {
            try {
                const response = await fetch(gasUrl);
                const data = await response.json();
                
                // é—œéµï¼šå¾å›å‚³ç‰©ä»¶ä¸­æå– allFiles é™£åˆ—
                const files = data.allFiles || [];
                
                document.getElementById('loading').style.display = 'none';
                const gallery = document.getElementById('gallery');
                gallery.innerHTML = "";
                
                if (files.length === 0) {
                    document.getElementById('loading').innerText = "ç›¸ç°¿ç›®å‰æ˜¯ç©ºçš„ï¼Œè«‹ç®¡ç†å“¡ç§»å‹•ç…§ç‰‡ã€‚";
                    document.getElementById('loading').style.display = 'block';
                    return;
                }

                files.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    
                    let mediaTag = "";
                    if (item.type.includes('video')) {
                        mediaTag = `<video src="${item.url}" muted playsinline onmouseover="this.play()" onmouseout="this.pause()"></video>`;
                    } else {
                        // è™•ç† HEIC æˆ–ä¸æ”¯æ´æ ¼å¼çš„æç¤º
                        mediaTag = `<img src="${item.url}" loading="lazy" onerror="this.src='https://placehold.co/160x150?text=HEIC+Format'">`;
                    }

                    div.innerHTML = `
                        ${mediaTag}
                        <p class="category-tag">[ ${item.category} ]</p>
                        <p class="file-name">${item.name}</p>
                    `;
                    gallery.appendChild(div);
                });
            } catch (err) {
                console.error(err);
                document.getElementById('loading').innerText = "è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª GAS æ¬Šé™è¨­å®šã€‚";
            }
        }

        // 3. ä¸Šå‚³æª”æ¡ˆ
        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) return alert("è«‹å…ˆé¸å–æª”æ¡ˆï¼");

            const btn = document.getElementById('uploadBtn');
            btn.innerText = "å‚³é€ä¸­...";
            btn.disabled = true;

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                const payload = {
                    userName: currentUser,
                    fileName: file.name,
                    fileData: e.target.result
                };

                try {
                    await fetch(gasUrl, {
                        method: "POST",
                        body: JSON.stringify(payload)
                    });
                    alert("ä¸Šå‚³æˆåŠŸï¼ç®¡ç†å“¡å¯©æ ¸å¾Œæœƒå‡ºç¾ã€‚");
                    fileInput.value = "";
                } catch (err) {
                    alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
                } finally {
                    btn.innerText = "é€å‡ºå›æ†¶";
                    btn.disabled = false;
                }
            };
            reader.readAsDataURL(file);
        }

        initLIFF();
    </script>
</body>
</html>
